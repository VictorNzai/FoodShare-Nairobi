<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodShare Charity Dashboard</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Noto+Sans:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: "Manrope", "Noto Sans", Arial, sans-serif;
        background: #f9fcf8;
        color: #111b0e;
      }
      header {
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        border-bottom: 1px solid #ddd;
        position: relative;
        z-index: 2;
      }
      .logo {
        font-weight: bold;
        font-size: 18px;
        color: #54d12b;
      }
      nav a {
        margin-left: 30px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }
      .sign-up-btn {
        background-color: #54d12b;
        color: white;
        padding: 8px 18px;
        border: none;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        margin-left: 30px;
      }
      .flex {
        display: flex;
        min-height: 100vh;
      }
      /* Sidebar */
      .sidebar {
        width: 250px;
        padding: 32px 24px;
        border-right: 1px solid #eaf3e7;
        background: #fff;
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        height: calc(100vh - 70px);
        z-index: 1;
      }
      @media (min-width: 1024px) {
        .sidebar {
          display: block;
        }
      }
      .sidebar .logo {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 32px;
        color: #54d12b;
      }
      .sidebar nav {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .sidebar nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        border-radius: 999px;
        background: none;
        color: #222;
        font-size: 15px;
        font-weight: 500;
        text-decoration: none;
        transition: background 0.2s, color 0.2s;
      }
      .sidebar nav a.active,
      .sidebar nav a:hover {
        background: #eaf3e7;
        color: #54d12b;
        font-weight: 700;
      }
      /* Main Content */
      .main-content {
        flex: 1;
        padding: 32px 24px;
        max-width: 1200px;
        margin: 0 auto;
        margin-left: 320px;
        margin-top: 70px;
      }
      .main-content h2 {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 24px;
        letter-spacing: -1px;
      }
      .stats {
        display: flex;
        gap: 24px;
        margin-bottom: 32px;
        flex-wrap: wrap;
      }
      .stat-card {
        background: #eaf3e7;
        border-radius: 18px;
        padding: 32px 24px;
        flex: 1 1 220px;
        min-width: 220px;
        text-align: center;
      }
      .stat-card p {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
        color: #222;
      }
      .stat-card .stat-value {
        font-size: 28px;
        font-weight: 800;
        color: #111b0e;
        margin-top: 8px;
      }
      .actions {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .action-btn {
        background: #66ea42;
        color: #111b0e;
        border: none;
        border-radius: 999px;
        padding: 12px 32px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
      }
      .action-btn.secondary {
        background: #eaf3e7;
        color: #222;
      }
      .action-btn:hover {
        background: #54d12b;
        color: #fff;
      }
      /* Table */
      .table-section {
        margin-bottom: 32px;
      }
      .table-section h3 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 12px;
      }
      .table-wrap {
        overflow-x: auto;
        border-radius: 16px;
        border: 1px solid #d5e7d0;
        background: #fff;
        margin-bottom: 24px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th,
      td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid #eaf3e7;
      }
      th {
        background: #f5f5f5;
        font-size: 15px;
        font-weight: 700;
        color: #222;
      }
      td {
        font-size: 14px;
        color: #222;
      }
      .status {
        display: inline-block;
        padding: 4px 16px;
        border-radius: 999px;
        background: #eaf3e7;
        color: #54d12b;
        font-weight: 700;
        font-size: 13px;
      }
      /* Responsive */
      @media (max-width: 900px) {
        .main-content {
          padding: 16px 4vw;
          margin-left: 0;
          margin-top: 70px;
        }
        .sidebar {
          display: none;
        }
        .stats {
          flex-direction: column;
          gap: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="logo"
        style="cursor: pointer"
        onclick="window.location.href='../../Index.html'"
      >
        üç¥ FoodShare
      </div>
      <nav>
        <a href="Profile.html">Profile</a>
        <a href="#" class="sign-up-btn" onclick="signOut()">Sign Out</a>
      </nav>
    </header>
    <div class="flex">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">FoodShare</div>
        <nav>
          <a href="#" class="active">Dashboard</a>
          <a href="PostFoodNeed.html" id="sidebar-post-need">Post Food Need</a>
          <a href="#" id="sidebar-browse-donor">Browse Donor Offers</a>
          <a href="Requests.html">Requests</a>
          <!-- <a href="#">Beneficiaries</a> -->
          <a href="Profile.html">Profile</a>
          <a href="Feedback.html" id="sidebar-feedback">Feedback</a>
        </nav>
      </aside>
      <!-- Main Content -->
      <div
        style="
          flex: 1;
          display: flex;
          flex-direction: column;
          min-height: 100vh;
        "
      >
        <main class="main-content">
          <h2 id="charity-greeting">Welcome back, Charity Org</h2>
          <div class="stats">
            <div class="stat-card">
              <p>Active Requests</p>
              <div class="stat-value">7</div>
            </div>
            <div class="stat-card">
              <p>Total Donations Received</p>
              <div class="stat-value" id="total-donations-kg">1,200 kg</div>
            </div>
            <div class="stat-card">
              <p>Beneficiaries Served</p>
              <div class="stat-value">350</div>
            </div>
          </div>
          <div class="actions">
            <a href="PostFoodNeed.html"
              ><button class="action-btn">Post a New Food Need</button></a
            >
            <button class="action-btn secondary">Browse Donor Offers</button>
          </div>
          <div class="table-section">
            <h3>Recent Activity</h3>
            <div class="table-wrap">
              <table id="recent-activity-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Food Item</th>
                    <th>Quantity</th>
                    <th>Pickup Location</th>
                    <th>Notes</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="recent-activity-body">
                  <!-- Dynamic rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>
    <script>
      function signOut() {
        window.location.href = "../Login.html";
      }
      // Set greeting from localStorage if available
      let charityName = "Charity Org";
      try {
        const jwt = JSON.parse(localStorage.getItem("jwt"));
        if (jwt && jwt.name) charityName = jwt.name;
      } catch {}
      document.getElementById("charity-greeting").textContent =
        "Welcome back, " + charityName;

      // Dynamically load food needs from backend for this org
      async function renderRecentActivity() {
        const tbody = document.getElementById("recent-activity-body");
        tbody.innerHTML = "";
        let jwt = localStorage.getItem("jwt");
        let orgName = "";
        try {
          const jwtObj = JSON.parse(jwt);
          if (jwtObj && jwtObj.name) orgName = jwtObj.name;
        } catch {}
        if (!orgName) {
          tbody.innerHTML =
            '<tr><td colspan="7">Please log in as a charity to view your activity.</td></tr>';
          return;
        }

        try {
          // Fetch food needs
          const res = await fetch(
            "http://localhost:3000/api/foodneeds?org=" +
              encodeURIComponent(orgName),
            {
              headers: jwt ? { Authorization: "Bearer " + jwt } : {},
            }
          );
          if (!res.ok) throw new Error("Failed to fetch food needs");
          const foodNeeds = await res.json();

          // Fetch completed donor offers for this org
          let donorOffers = [];
          try {
            const offersRes = await fetch(
              `/api/donor-offers?charity=${encodeURIComponent(
                orgName
              )}&status=Completed`,
              { headers: jwt ? { Authorization: "Bearer " + jwt } : {} }
            );
            if (offersRes.ok) {
              const offersData = await offersRes.json();
              donorOffers = Array.isArray(offersData.offers)
                ? offersData.offers
                : [];
            }
          } catch {}

          // Update Active Requests stat
          const activeCount = foodNeeds.filter(
            (need) => need.status === "Pending"
          ).length;
          const statCards = document.querySelectorAll(".stat-card");
          statCards.forEach((card) => {
            const label = card.querySelector("p");
            const value = card.querySelector(".stat-value");
            if (label && value) {
              if (label.textContent.includes("Active Requests")) {
                value.textContent = activeCount;
              } else if (
                label.textContent.includes("Total Donations Received")
              ) {
                // Sum quantity for completed requests in kg
                let totalKg = foodNeeds
                  .filter(
                    (need) =>
                      need.status === "Completed" &&
                      String(need.quantity).toLowerCase().includes("kg")
                  )
                  .reduce((sum, need) => {
                    let qty = parseFloat(
                      String(need.quantity).replace(/[^\d.]/g, "")
                    );
                    return sum + (isNaN(qty) ? 0 : qty);
                  }, 0);
                // Add completed donor offers (in kg)
                let donorKg = donorOffers
                  .filter((offer) =>
                    String(offer.unit || "")
                      .toLowerCase()
                      .includes("kg")
                  )
                  .reduce((sum, offer) => {
                    let qty = parseFloat(
                      String(offer.quantity).replace(/[^\d.]/g, "")
                    );
                    return sum + (isNaN(qty) ? 0 : qty);
                  }, 0);
                value.textContent = totalKg + donorKg + " kg";
              } else if (label.textContent.includes("Beneficiaries Served")) {
                // Count completed requests as beneficiaries served
                let served = foodNeeds.filter(
                  (need) => need.status === "Completed"
                ).length;
                value.textContent = served;
              }
            }
          });

          // Merge and sort recent activity: food needs and donor offers
          let activityRows = [];
          foodNeeds.forEach((need) => {
            activityRows.push({
              date: need.date ? String(need.date).slice(0, 10) : "",
              type: "Request",
              food_item: need.food_item,
              quantity: need.quantity,
              pickup_location: need.pickup_location,
              notes: need.notes || "",
              status: need.status,
            });
          });
          donorOffers.forEach((offer) => {
            activityRows.push({
              date: offer.completed_at
                ? String(offer.completed_at).slice(0, 10)
                : offer.updated_at
                ? String(offer.updated_at).slice(0, 10)
                : offer.created_at
                ? String(offer.created_at).slice(0, 10)
                : "",
              type: "Donation",
              food_item: offer.food_type || offer.food_item || "",
              quantity:
                (offer.quantity || "") + (offer.unit ? " " + offer.unit : ""),
              pickup_location:
                offer.pickup_address || offer.pickup_location || "",
              notes: offer.notes || offer.message || "",
              status: offer.status || "Completed",
            });
          });
          // Sort by date descending
          activityRows.sort((a, b) =>
            (b.date || "").localeCompare(a.date || "")
          );

          if (activityRows.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7">No food needs or donations yet.</td></tr>';
          } else {
            activityRows.forEach((row) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.type}</td>
                <td>${row.food_item}</td>
                <td>${row.quantity}</td>
                <td>${row.pickup_location}</td>
                <td>${row.notes}</td>
                <td><span class="status">${row.status}</span></td>
              `;
              tbody.appendChild(tr);
            });
          }
        } catch (err) {
          tbody.innerHTML =
            '<tr><td colspan="7">Error loading activity.</td></tr>';
        }
        // Optionally, add static rows below if needed
      }
      renderRecentActivity();

      // Sidebar actions for Post Need and Browse Donor Offers
      document.getElementById("sidebar-post-need").onclick = function (e) {
        e.preventDefault();
        window.location.href = "PostFoodNeed.html";
      };
      document.getElementById("sidebar-browse-donor").onclick = function (e) {
        e.preventDefault();
        window.location.href = "BrowseDonorOffers.html";
      };
      document.getElementById("sidebar-requests").onclick = function () {
        // Scroll to or focus on recent activity table
        document
          .querySelector(".table-section")
          .scrollIntoView({ behavior: "smooth" });
      };
      document.getElementById("sidebar-reports").onclick = function () {
        // Implement reports view (Amt to Donation received)
        alert("Reports feature coming soon!");
      };
    </script>
  </body>
</html>
